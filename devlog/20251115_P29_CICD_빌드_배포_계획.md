# P29: CI/CD 빌드 및 배포 자동화 계획 (2025-11-15)

## 개요

Modan2 프로젝트의 CI/CD workflow를 참고하여 ACC 프로젝트에 PyInstaller 빌드 및 InnoSetup 설치 파일 생성 자동화를 구축합니다.

---

## 목표

1. ✅ PyInstaller로 onedir 실행 파일 생성
2. ✅ InnoSetup으로 Windows 설치 파일 생성
3. ✅ GitHub Actions를 통한 자동 빌드
4. ✅ Tag 푸시 시 자동 Release 생성
5. ✅ 멀티 플랫폼 빌드 (Windows, macOS, Linux)

---

## 현재 상태 분석

### ACC 프로젝트 구조

```
ACC/
├── acc_gui.py              # 메인 GUI 애플리케이션 (PyQt6)
├── acc_core.py             # 핵심 알고리즘
├── acc_core_new.py         # 반복적 알고리즘
├── acc_utils.py            # 유틸리티 함수
├── data/                   # 샘플 데이터
│   ├── sample_subordinate.csv
│   └── sample_inclusive.csv
├── images/                 # GUI 이미지 리소스
├── docs/                   # Sphinx 문서
└── tests/                  # pytest 테스트
```

### 메인 애플리케이션
- **acc_gui.py**: PyQt6 기반 GUI 애플리케이션
- 엔트리 포인트: `if __name__ == "__main__":`

### 필요한 파일
- ❌ `version.py`: 버전 정보 파일 (생성 필요)
- ❌ `build.py`: PyInstaller 빌드 스크립트 (생성 필요)
- ❌ `InnoSetup/ACC.iss.template`: InnoSetup 템플릿 (생성 필요)
- ❌ `requirements.txt`: 프로덕션 의존성 (생성 필요)

---

## Modan2 CI/CD 분석

### Workflow 구조

```
release.yml (Tag 푸시 시)
  ├─> test.yml (테스트 실행)
  ├─> reusable_build.yml (재사용 가능 빌드)
  │   ├─> build-windows
  │   ├─> build-macos
  │   └─> build-linux
  └─> create-release (Release 생성)
```

### 주요 구성 요소

#### 1. Windows 빌드 (reusable_build.yml:10-101)
```yaml
- Python 3.12 설치
- requirements.txt 의존성 설치
- PyInstaller 설치
- version.py에서 버전 추출
- Inno Setup 6.2.2 다운로드 및 설치
- build.py 실행 (PyInstaller + InnoSetup)
- 설치 파일 또는 Portable ZIP 생성
- Artifact 업로드
```

#### 2. macOS 빌드 (reusable_build.yml:102-230)
```yaml
- Python 3.12 설치
- Qt5, create-dmg 설치
- PyInstaller로 .app 번들 생성
- Info.plist 생성
- DMG 파일 생성
- Artifact 업로드
```

#### 3. Linux 빌드 (reusable_build.yml:231-300)
```yaml
- Python 3.12 설치
- Qt5, XCB 라이브러리 설치
- linuxdeploy, appimagetool 설치
- PyInstaller 빌드
- AppImage 생성
- Artifact 업로드
```

#### 4. Release 생성 (release.yml:21-92)
```yaml
- 모든 Artifact 다운로드
- SHA256 체크섬 생성
- RELEASE_NOTES.md 읽기
- GitHub Release 생성
- 파일 업로드 (.zip, .exe, .dmg, .AppImage)
```

---

## ACC 프로젝트 적용 계획

### Phase 1: 기본 파일 생성

#### 1.1. version.py 생성
```python
"""ACC version information"""
__version__ = "0.1.0"
__app_name__ = "ACC"
__author__ = "jikhanjung"
__description__ = "Area Affinity in Concentric Circles"
```

#### 1.2. requirements.txt 생성
현재 프로젝트 의존성 정리:
```
PyQt6>=6.5.0
matplotlib>=3.7.0
scipy>=1.11.0
pandas>=2.0.0
numpy>=1.24.0
```

#### 1.3. build.py 생성
Modan2의 build.py를 ACC에 맞게 수정:
- 메인 스크립트: `acc_gui.py`
- 앱 이름: `ACC`
- 포함할 데이터: `data/`, `images/`
- PyInstaller 옵션:
  - `--onedir` (디렉토리 모드)
  - `--windowed` (콘솔 숨김)
  - `--name=ACC`
  - `--add-data "data:data"`
  - `--add-data "images:images"`

#### 1.4. InnoSetup/ACC.iss.template 생성
```iss
#define AppVersion "{{VERSION}}"
#define BuildNumber GetEnv('BUILD_NUMBER')

[Setup]
AppName=ACC
AppVersion={#AppVersion}
DefaultDirName={userappdata}\ACC
OutputDir={{DIST_PATH}}\..\InnoSetup\Output
Compression=lzma/normal
SolidCompression=no
OutputBaseFilename=ACC_v{#AppVersion}_build{#BuildNumber}_Installer

[Files]
Source: "{{DIST_PATH}}\ACC\ACC.exe"; DestDir: "{app}"
Source: "{{DIST_PATH}}\ACC\*"; DestDir: "{app}"; Flags: recursesubdirs

[Icons]
Name: "{userprograms}\ACC"; Filename: "{app}\ACC.exe"

[Run]
Filename: "{app}\ACC.exe"; Flags: postinstall shellexec
```

### Phase 2: GitHub Actions Workflows 생성

#### 2.1. .github/workflows/build.yml
수동 빌드 트리거용:
```yaml
name: Build
on:
  workflow_dispatch:
    inputs:
      build_number:
        description: 'Build number'
        required: false
        default: '0'

jobs:
  build:
    uses: ./.github/workflows/reusable_build.yml
    with:
      build_number: ${{ github.event.inputs.build_number || github.run_number }}
```

#### 2.2. .github/workflows/reusable_build.yml
재사용 가능한 빌드 워크플로우:
- `build-windows`: Windows .exe + 설치 파일
- `build-macos`: macOS .app + .dmg
- `build-linux`: AppImage

#### 2.3. .github/workflows/release.yml 수정
기존 test.yml 통합 + 빌드 + Release 생성:
```yaml
name: Release
on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  test:
    uses: ./.github/workflows/test.yml

  build:
    needs: test
    uses: ./.github/workflows/reusable_build.yml
    with:
      build_number: ${{ github.run_number }}

  create-release:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - Download artifacts
      - Generate SHA256
      - Create GitHub Release
      - Upload files
```

### Phase 3: 빌드 스크립트 구현

#### 3.1. build.py 주요 함수
```python
def get_pyinstaller_args():
    """ACC용 PyInstaller 인자 반환"""
    return [
        '--onedir',
        '--windowed',
        '--name=ACC',
        '--add-data', 'data:data',
        '--add-data', 'images:images',
        'acc_gui.py'
    ]

def build_windows():
    """Windows 빌드"""
    run_pyinstaller(get_pyinstaller_args())
    generate_innosetup_script()
    run_innosetup()

def build_macos():
    """macOS 빌드"""
    run_pyinstaller(get_pyinstaller_args())
    create_app_bundle()
    create_dmg()

def build_linux():
    """Linux 빌드"""
    run_pyinstaller(get_pyinstaller_args())
    create_appimage()
```

### Phase 4: 테스트 및 검증

#### 4.1. 로컬 빌드 테스트
```bash
# Windows
python build.py

# 결과 확인
dist/ACC/ACC.exe  # 실행 파일
InnoSetup/Output/ACC_v0.1.0_build0_Installer.exe  # 설치 파일
```

#### 4.2. GitHub Actions 테스트
```bash
# 수동 빌드 트리거
# GitHub UI에서 Actions > Build > Run workflow

# Tag 푸시로 Release 테스트
git tag v0.1.0
git push origin v0.1.0
```

### Phase 5: 문서화

#### 5.1. README.md 업데이트
- 빌드 배지 추가
- 설치 방법 추가
- Release 다운로드 링크 추가

#### 5.2. BUILDING.md 생성
빌드 방법 상세 문서:
- 로컬 빌드 방법
- CI/CD 워크플로우 설명
- 버전 관리 및 Release 절차

---

## 구현 순서

### 1단계: 기본 설정 (30분)
- [x] version.py 생성
- [x] requirements.txt 생성
- [x] .gitignore 업데이트 (build/, dist/, InnoSetup/Output/)

### 2단계: 빌드 스크립트 (1시간)
- [ ] build.py 작성
- [ ] InnoSetup 템플릿 작성
- [ ] 로컬 빌드 테스트 (Windows)

### 3단계: GitHub Actions (1시간)
- [ ] reusable_build.yml 작성
- [ ] build.yml 작성 (수동 트리거)
- [ ] release.yml 수정

### 4단계: 멀티 플랫폼 (1시간)
- [ ] macOS 빌드 설정
- [ ] Linux 빌드 설정
- [ ] packaging/linux/create_appimage.sh 작성

### 5단계: 테스트 및 문서화 (30분)
- [ ] 수동 빌드 테스트
- [ ] Release 테스트 (v0.1.0-alpha)
- [ ] README.md 업데이트
- [ ] BUILDING.md 작성

**총 예상 시간**: 약 4시간

---

## Modan2와의 주요 차이점

| 항목 | Modan2 | ACC |
|------|--------|-----|
| GUI 프레임워크 | PyQt5 | PyQt6 |
| 메인 스크립트 | MdMain.py | acc_gui.py |
| 앱 이름 | Modan2 | ACC |
| 데이터 디렉토리 | ExampleDataset/ | data/ |
| 이미지 리소스 | icons/ | images/ |
| 설치 위치 | {userappdata}\PaleoBytes\Modan2 | {userappdata}\ACC |
| Start Menu | PaleoBytes\Modan2 | ACC |

---

## 파일 구조 (완료 후)

```
ACC/
├── .github/
│   └── workflows/
│       ├── test.yml                  # ✅ 기존 (테스트)
│       ├── docs.yml                  # ✅ 기존 (문서)
│       ├── build.yml                 # ⭐ 새로 생성 (수동 빌드)
│       ├── reusable_build.yml        # ⭐ 새로 생성 (재사용 빌드)
│       └── release.yml               # ⭐ 수정 (Release)
├── InnoSetup/
│   └── ACC.iss.template              # ⭐ 새로 생성
├── packaging/
│   └── linux/
│       └── create_appimage.sh        # ⭐ 새로 생성
├── build/
│   └── file_version_info.txt         # ⭐ 새로 생성 (Windows)
├── version.py                        # ⭐ 새로 생성
├── build.py                          # ⭐ 새로 생성
├── requirements.txt                  # ⭐ 새로 생성
├── BUILDING.md                       # ⭐ 새로 생성
└── [기존 파일들...]
```

---

## 예상 결과물

### GitHub Release 파일
```
ACC-v0.1.0 Release
├── ACC-Windows-Installer-v0.1.0-buildXXX.zip
│   └── ACC_v0.1.0_buildXXX_Installer.exe
├── ACC-macOS-Installer-v0.1.0-buildXXX.dmg
├── ACC-Linux-v0.1.0-buildXXX.AppImage
└── SHA256SUMS.txt
```

### 설치 파일 특징
- **Windows**: InnoSetup 설치 파일 (~100-200MB)
- **macOS**: DMG 이미지 파일 (~100-200MB)
- **Linux**: AppImage 실행 파일 (~100-200MB)

---

## 보안 및 고려사항

### 1. 코드 서명
- Windows: Authenticode 서명 (추후 추가)
- macOS: Apple Developer ID 서명 (추후 추가)
- Linux: GPG 서명 (선택사항)

### 2. 바이러스 백신 오탐
- InnoSetup 압축 레벨 조정 (lzma/normal)
- SolidCompression=no 설정
- 첫 Release 후 주요 AV에 오탐 신고

### 3. 자동 업데이트
- 향후 추가 고려사항
- GitHub Releases API 사용
- Sparkle (macOS), WinSparkle (Windows)

---

## 성공 기준

- [x] 로컬에서 빌드 성공 (Windows)
- [ ] GitHub Actions 빌드 성공 (Windows)
- [ ] GitHub Actions 빌드 성공 (macOS)
- [ ] GitHub Actions 빌드 성공 (Linux)
- [ ] Tag 푸시 시 Release 자동 생성
- [ ] 설치 파일 다운로드 및 실행 테스트
- [ ] 문서화 완료

---

## 참고 자료

- Modan2 workflows: `/mnt/d/projects/Modan2/.github/workflows/`
- Modan2 build.py: `/mnt/d/projects/Modan2/build.py`
- PyInstaller 문서: https://pyinstaller.org/
- Inno Setup 문서: https://jrsoftware.org/isinfo.php
- GitHub Actions 문서: https://docs.github.com/actions

---

## 다음 단계

1. version.py, requirements.txt 생성
2. build.py 작성 및 로컬 테스트
3. InnoSetup 템플릿 작성
4. GitHub Actions workflows 생성
5. 테스트 및 문서화

계획 수립 완료. 이제 구현을 시작합니다.
