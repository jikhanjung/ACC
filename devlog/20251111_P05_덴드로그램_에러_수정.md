# 20251111 P05: 덴드로그램 중간 단계 에러 수정

## 문제

```
Error plotting dendrogram: Dimensions of Z and labels must be consistent.
```

### 원인

scipy의 `dendrogram()` 함수는 **완전한 linkage matrix**를 기대합니다:
- n개 항목 → (n-1)×4 linkage matrix 필요
- Partial linkage (예: 2×4)를 전달하면 차원 불일치 에러 발생

### 이전 구현 (문제)

```python
# Step i까지의 일부 linkage만 전달
partial_linkage = linkage_matrix[:step_num, :]  # 예: 2×4
dendrogram(partial_linkage, labels=original_labels)  # 6개 labels
# → 에러! 2×4 linkage는 3개 항목을 위한 것인데 6개 labels 전달
```

## 해결 방법

**전체 dendrogram을 그리되, 완료된 단계만 색상으로 강조**

### 새로운 구현

```python
def link_color_func(k):
    """
    클러스터 k가 어느 step에서 형성되었는지 확인
    현재 step 이하면 파란색, 이후면 회색
    """
    cluster_step = k - n + 1
    if cluster_step <= current_step:
        return 'blue'      # 완료된 merge
    else:
        return 'lightgray'  # 아직 안된 merge

# 전체 dendrogram 그리기 (색상 구분)
dendrogram(
    full_linkage,
    labels=original_labels,
    link_color_func=link_color_func,  # 커스텀 색상
    ...
)

# 현재 step의 height에 빨간 점선 추가
current_height = full_linkage[current_step - 1, 2]
ax.axvline(x=current_height, color='red', linestyle='--',
          linewidth=2, alpha=0.7, label=f'Step {current_step}')
```

## 시각적 개선

### Step 1
- **파란색**: J-T 연결 (완료)
- **회색**: 나머지 모든 연결 (아직 안됨)
- **빨간 점선**: Step 1의 distance 위치

### Step 2
- **파란색**: J-T, O-Q 연결 (완료)
- **회색**: 나머지 연결 (아직 안됨)
- **빨간 점선**: Step 2의 distance 위치

### Step 5 (마지막)
- **파란색**: 모든 연결 (전부 완료)
- **회색**: 없음
- **빨간 점선**: 최종 병합 distance

## 장점

1. **에러 없음**: 항상 완전한 linkage matrix 사용
2. **맥락 유지**: 전체 구조를 보면서 진행 상황 확인 가능
3. **명확한 진행도**: 파란색/회색으로 완료/미완료 구분
4. **현재 위치 표시**: 빨간 점선으로 현재 step의 위치 명확히 표시

## 테스트 결과

```bash
$ python test_step_dendro.py

Number of original items: 6
Cluster IDs: 6 to 10

Step 1:
  Cluster 6 (step 1): blue      ✓
  Cluster 7 (step 2): lightgray ✓
  Cluster 8 (step 3): lightgray ✓
  ...

Step 2:
  Cluster 6 (step 1): blue      ✓
  Cluster 7 (step 2): blue      ✓
  Cluster 8 (step 3): lightgray ✓
  ...

Saved test plot to test_step_dendro.png
```

테스트 이미지에서 확인:
- ✅ 완료된 단계는 파란색
- ✅ 미완료 단계는 회색
- ✅ 빨간 점선이 현재 위치 표시

## 대안 고려사항

### 대안 1: Partial dendrogram 직접 그리기
- matplotlib로 노드와 선을 직접 그림
- 복잡하고 dendrogram 레이아웃 알고리즘 필요
- ❌ 구현 복잡도 높음

### 대안 2: 텍스트 설명만
- Dendrogram 없이 텍스트로만 진행 상황 표시
- ❌ 시각적 효과 없음

### 선택한 방법: 색상 하이라이트
- ✅ 구현 간단 (link_color_func만 추가)
- ✅ 전체 맥락 유지
- ✅ 시각적으로 명확
- ✅ scipy 기능 활용

## 코드 변경

### 변경 전
```python
# partial_linkage로 그리기 (에러)
partial_linkage = step_manager.get_partial_linkage(current_step)
dendrogram(partial_linkage, labels=original_labels)  # ❌ 에러
```

### 변경 후
```python
# 전체 linkage + 색상 구분
full_linkage = step_manager.linkage_matrix

def link_color_func(k):
    cluster_step = k - n + 1
    return 'blue' if cluster_step <= current_step else 'lightgray'

dendrogram(
    full_linkage,
    labels=original_labels,
    link_color_func=link_color_func  # ✅ 색상으로 진행도 표시
)

# 현재 위치 표시
current_height = full_linkage[current_step - 1, 2]
ax.axvline(x=current_height, color='red', linestyle='--', label=f'Step {current_step}')
ax.legend()
```

## Cluster ID 계산

scipy linkage에서:
- 원본 항목 ID: 0, 1, 2, ..., n-1
- 병합된 클러스터 ID: n, n+1, ..., 2n-2
- Step i에서 생성된 클러스터 ID: n + i - 1

예시 (n=6):
```
Step 1: 클러스터 6 생성 (6 - 6 + 1 = 1)
Step 2: 클러스터 7 생성 (7 - 6 + 1 = 2)
Step 3: 클러스터 8 생성 (8 - 6 + 1 = 3)
...
```

따라서:
```python
cluster_step = k - n + 1
```

## 사용자 경험

### Before (에러 발생)
- Step 0: "Original Matrix" 텍스트
- Step 1~n-1: **에러 메시지 표시** ❌
- Step n: 전체 dendrogram

### After (색상 하이라이트)
- Step 0: "Original Matrix" 텍스트
- Step 1: 전체 dendrogram, J-T만 파란색 ✅
- Step 2: 전체 dendrogram, J-T, O-Q 파란색 ✅
- ...
- Step 5: 전체 dendrogram, 모두 파란색 ✅
- 각 step마다 **빨간 점선**으로 위치 표시

## 추가 개선 가능성

### 1. 애니메이션
```python
# Step 0 → Step 1 전환 시
# 회색에서 파란색으로 fade in 효과
```

### 2. 인터랙티브 툴팁
```python
# 각 링크에 마우스 오버 시
# "Step 2: Merge (O) + (Q), similarity=0.850" 표시
```

### 3. 확대/축소
```python
# 현재 step 주변만 확대해서 표시
# 나머지는 축소
```

### 4. 단계별 강조
```python
# 현재 step의 링크를 더 굵게 표시
linewidths = [3 if step == current_step else 1 for step in steps]
```

## 결론

Partial dendrogram 에러 해결:
- ✅ scipy의 제약사항 우회
- ✅ 전체 구조 유지하면서 진행도 표시
- ✅ 색상으로 직관적 표현
- ✅ 빨간 점선으로 현재 위치 명확히 표시
- ✅ 추가 라이브러리 없이 구현

모든 step에서 에러 없이 dendrogram이 표시됩니다!
