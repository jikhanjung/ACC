# P35: 유사도 계산 연동 (Raw Data → Similarity Matrix)

**작성일**: 2026-02-11
**상태**: 계획
**선행 작업**: P34 (Raw Data Panel 추가) — 완료

---

## 1. 목표

DataPanel의 presence/absence 데이터로부터 유사도(similarity)를 계산하여 LeftPanel의 Local/Global matrix에 자동 전달한다. 이를 통해 Raw Data → Similarity → Dendrogram → ACC 전체 파이프라인을 완성한다.

## 2. 개념 구조

```
DataPanel (1번째 패널)                  LeftPanel (2번째 패널)
┌────────────────────────┐             ┌──────────────────────┐
│  [Tab: Tremadoc]  ◄─── 현재 탭 ──→  │  Local Similarity    │
│  [Tab: Llanvirn]       │             │  Matrix (위쪽)       │
│  [Tab: Caradoc]        │             ├──────────────────────┤
│                        │             │  Global Similarity   │
│  전체 탭 union ─────────────────→    │  Matrix (아래쪽)     │
└────────────────────────┘             └──────────────────────┘
```

### Local Similarity
- **현재 선택된 탭**의 presence/absence 데이터로 계산
- 하나의 시기(sub-period) 내에서 area 간 유사도
- 예: Ordovician 전체 중 Tremadoc 탭 선택 → Tremadoc 시기의 area 간 유사도

### Global Similarity
- **모든 탭의 데이터를 합친(union)** presence/absence로 계산
- 전체 시기에 걸친 area 간 유사도
- 예: Tremadoc + Llanvirn + Caradoc의 taxa를 모두 합쳐서 계산

### Union 규칙
- 각 탭의 taxa 목록은 다를 수 있음
- Union 시 모든 탭의 taxa를 합집합
- 특정 탭에 없는 taxon은 해당 탭에서 모든 area에 대해 0(absent)으로 간주
- Area 목록은 모든 탭에서 **동일**해야 함 (제약 조건)

## 3. Area 동기화 제약

모든 탭은 동일한 area 목록을 공유해야 한다.

### 동기화 방식
- 한 탭에서 area를 추가/삭제/이름변경하면 다른 모든 탭에도 반영
- 새 시트 추가 시 기존 시트의 area 목록을 복사 (taxa는 빈 상태)
- Area 관리는 DataPanel 레벨에서 통제 (개별 테이블이 아닌 패널 단위)

### 구현
- `DataPanel`에 공유 area 목록 관리 (`self.shared_areas`)
- Area 추가/삭제 시 모든 탭의 테이블에 동시 반영
- 개별 `PresenceAbsenceTable`의 area 변경은 `DataPanel`을 통해 전파

## 4. 유사도 계수

Jaccard 계수를 기본으로 사용하며, 향후 다른 계수도 추가 가능하도록 설계한다.

### Jaccard 계수
```
J(A, B) = |A ∩ B| / |A ∪ B|
```
- A, B: 두 area에 존재하는 taxa 집합
- 교집합 크기 / 합집합 크기
- 범위: 0 (완전 불일치) ~ 1 (완전 일치)

### 향후 추가 가능
- **Simpson**: `|A ∩ B| / min(|A|, |B|)` — 크기 차이가 큰 집합에 유리
- **Dice/Sørensen**: `2|A ∩ B| / (|A| + |B|)`

## 5. 데이터 흐름

```
1. 사용자가 DataPanel에서 "Calculate Similarity" 버튼 클릭
2. 현재 탭 데이터 → Jaccard 계산 → local_similarity_df (pandas DataFrame)
3. 전체 탭 union 데이터 → Jaccard 계산 → global_similarity_df (pandas DataFrame)
4. MainWindow를 통해:
   - left_panel.local_matrix_widget.update_matrix(local_similarity_df)
   - left_panel.global_matrix_widget.update_matrix(global_similarity_df)
5. LeftPanel이 매트릭스를 받으면 자동으로 dendrogram 갱신 트리거
```

## 6. 구현 단계

### Phase 1: Area 동기화
1. `DataPanel`에 `shared_areas` 속성 추가
2. Area 추가/삭제/이름변경 시 모든 탭 동기화 로직
3. 새 시트 추가 시 기존 area 목록 상속

### Phase 2: 유사도 계산 함수
1. `calculate_jaccard_matrix(areas, taxa, matrix)` → DataFrame
2. `calculate_union_matrix(all_sheets_data)` → 합친 presence/absence matrix
3. `acc_utils.py`에 배치 또는 별도 `similarity.py` 모듈

### Phase 3: UI 연결
1. DataPanel에 "Calculate Similarity" 버튼 추가 (또는 기존 버튼 활용)
2. 버튼 클릭 시 local/global 유사도 계산
3. MainWindow를 통해 LeftPanel에 결과 전달
4. 탭 변경 시 자동 재계산 옵션 (선택)

### Phase 4: 검증 및 예외 처리
1. Area가 2개 미만일 때 경고
2. 모든 area에 taxa가 없을 때 (빈 행) 처리
3. 모든 탭이 비어있을 때 global 계산 스킵
4. 계산 결과의 대칭성 및 대각선 1.0 보장

## 7. 수정 대상 파일

| 파일 | 변경 내용 |
|------|----------|
| `acc_gui.py` | DataPanel에 Calculate 버튼, area 동기화 로직 추가 |
| `acc_gui.py` | MainWindow에 유사도 결과 전달 메서드 추가 |
| `acc_utils.py` (또는 신규) | Jaccard 계산 함수 구현 |

## 8. 우선순위

이번 작업: **Phase 1 ~ Phase 3** (area 동기화 + 유사도 계산 + UI 연결)
Phase 4는 기본 동작 확인 후 보강.
