# P28: 테스트 체계화 및 테스트 스위트 구축 (2025-11-15)

## 개요

현재 프로젝트 루트에 산재한 17개의 테스트 스크립트를 분석하고, pytest 기반의 체계적인 단위 테스트/통합 테스트 스위트를 `tests/` 디렉토리에 구축하는 작업입니다.

---

## 현황 분석

### 기존 테스트 파일 목록 (17개, 총 1,349줄)

#### 1. 알고리즘 테스트 (6개)
- `test_acc_steps.py` (77줄): ACC 단계별 알고리즘 테스트
- `test_integration.py` (69줄): CSV → ACC 전체 파이프라인 통합 테스트
- `test_concentric.py` (77줄): 동심원 구조 검증
- `test_linkage_abc.py` (79줄): Linkage similarity 계산 검증
- `test_abc_example.py` (43줄): 3-영역 간단한 예제
- `test_nested_structure.py` (29줄): 중첩 구조 테스트

#### 2. 검증 스크립트 (1개)
- `verify_concentric_full.py` (67줄): 6-영역 동심원 검증

#### 3. GUI 테스트 (5개)
- `test_area_editor.py` (134줄): Area 편집기 다이얼로그 테스트
- `test_empty_area_list.py` (134줄): 빈 area list 처리 테스트
- `test_step_dendro.py` (80줄): Dendrogram 단계 시각화 테스트
- `test_dialog.py` (44줄): 기본 다이얼로그 테스트
- `test_gui_simple.py` (31줄): 간단한 GUI 테스트

#### 4. 환경/의존성 테스트 (5개)
- `test_pyqt5.py` (37줄): PyQt5 import 테스트
- `test_matplotlib_qt5.py` (71줄): Matplotlib Qt5 백엔드 테스트
- `test_canvas_import.py` (73줄): Canvas import 테스트
- `test_clustering_steps.py` (53줄): Clustering manager 테스트
- `test_acc_with_log.py` (35줄): 로깅 기능 테스트

#### 5. 특정 기능 테스트 (1개)
- `test_merge_radii.py` (78줄): Radii merge 알고리즘 테스트

### 문제점

1. **구조 없음**: 모든 파일이 루트 디렉토리에 산재
2. **일관성 부족**: pytest/unittest 혼용, 네이밍 불일치
3. **중복 코드**: 샘플 데이터 반복 정의
4. **실행 어려움**: 개별 실행만 가능, 전체 테스트 실행 불가
5. **CI/CD 미지원**: GitHub Actions 통합 없음
6. **커버리지 미측정**: 테스트 커버리지 알 수 없음

---

## 테스트 체계화 계획

### 목표

1. ✅ pytest 기반 통합 테스트 스위트 구축
2. ✅ 단위 테스트 / 통합 테스트 분리
3. ✅ 테스트 커버리지 80% 이상 달성
4. ✅ CI/CD 파이프라인 구축 (GitHub Actions)
5. ✅ 문서화 및 유지보수성 향상

### 디렉토리 구조

```
tests/
├── __init__.py
├── conftest.py                 # pytest 설정, fixtures
├── test_data/                  # 테스트 데이터
│   ├── sample_subordinate.csv
│   ├── sample_inclusive.csv
│   ├── invalid_asymmetric.csv
│   └── invalid_diagonal.csv
├── unit/                       # 단위 테스트
│   ├── __init__.py
│   ├── test_acc_core.py        # acc_core.py 함수들
│   ├── test_acc_core_new.py    # acc_core_new.py 함수들
│   ├── test_acc_utils.py       # acc_utils.py 함수들
│   └── test_data_structures.py # DendroNode 등
├── integration/                # 통합 테스트
│   ├── __init__.py
│   ├── test_pipeline.py        # CSV → Dendrogram → ACC
│   ├── test_algorithm.py       # 알고리즘 전체 흐름
│   └── test_validation.py      # 데이터 검증 파이프라인
├── gui/                        # GUI 테스트
│   ├── __init__.py
│   ├── test_main_window.py     # 메인 윈도우
│   ├── test_matrix_widget.py   # Matrix 편집
│   ├── test_dendrogram_widget.py  # Dendrogram 시각화
│   ├── test_acc_widget.py      # ACC 시각화
│   └── test_dialogs.py         # Area editor 등
└── performance/                # 성능 테스트 (선택)
    ├── __init__.py
    └── test_benchmark.py       # 대규모 데이터 처리
```

---

## 테스트 카테고리 및 내용

### 1. 단위 테스트 (Unit Tests)

**tests/unit/test_acc_core.py**:
- `DendroNode` 생성 및 속성
- `find_cluster_in_dendro_by_members()`
- `average_pairwise_similarity()`
- `extract_clusters_from_dendro()`
- `decorate_clusters()`
- `place_first_cluster()`
- `add_area_to_cluster()`
- `merge_two_clusters()`

**tests/unit/test_acc_core_new.py**:
- `build_acc_iterative()` 각 단계
- `calculate_cluster_similarity()`
- Concentric circles 구조 검증
- Rotation-based merge 검증

**tests/unit/test_acc_utils.py**:
- `similarity_to_distance()`
- `linkage_to_dendronode()`
- `matrix_to_dendrogram()`
- `validate_similarity_matrix()` - 모든 검증 규칙
- `dict_matrix_from_dataframe()`
- `build_acc_from_matrices()`

**tests/unit/test_data_structures.py**:
- `DendroNode` 구조
- Members set 연산
- Tree traversal

### 2. 통합 테스트 (Integration Tests)

**tests/integration/test_pipeline.py**:
- CSV 로드 → Dendrogram 생성 → ACC 생성
- 샘플 데이터 (6-영역) 전체 파이프라인
- 3-영역 간단한 예제
- 다양한 clustering method (average, single, complete)

**tests/integration/test_algorithm.py**:
- ACC vs ACC2 알고리즘 비교
- 단계별 진행 검증
- 최종 결과 일관성
- Concentric circles 구조 보존

**tests/integration/test_validation.py**:
- 비대칭 matrix 거부
- 대각선 != 1.0 거부
- 범위 초과 값 거부
- 라벨 불일치 감지

### 3. GUI 테스트 (GUI Tests)

**tests/gui/test_main_window.py**:
- 윈도우 생성 및 초기화
- 3-열 레이아웃 검증
- 버튼 클릭 이벤트

**tests/gui/test_matrix_widget.py**:
- CSV 로드
- Matrix 편집 (upper triangle만)
- Area list 편집
- 툴팁 표시

**tests/gui/test_dendrogram_widget.py**:
- Dendrogram 렌더링
- 슬라이더 단계 제어
- 자동 마지막 단계 이동
- 우클릭 이미지 저장

**tests/gui/test_acc_widget.py**:
- ACC/ACC2 시각화
- 단계별 표시
- Branch swap (ACC2)
- Hover tooltip (ACC2)

**tests/gui/test_dialogs.py**:
- Area Editor 다이얼로그
- Add/Remove/Move 기능
- 입력 검증

### 4. 성능 테스트 (Performance Tests, 선택)

**tests/performance/test_benchmark.py**:
- 10개 영역: < 1초
- 20개 영역: < 2초
- 50개 영역: < 10초
- 메모리 사용량 측정

---

## 기존 테스트 매핑

| 기존 파일 | 새 위치 | 변환 내용 |
|----------|--------|----------|
| `test_acc_steps.py` | `integration/test_pipeline.py` | 단계별 테스트 통합 |
| `test_integration.py` | `integration/test_pipeline.py` | CSV 파이프라인 |
| `test_concentric.py` | `integration/test_algorithm.py` | 동심원 검증 |
| `test_linkage_abc.py` | `unit/test_acc_core_new.py` | Linkage 계산 |
| `test_abc_example.py` | `integration/test_pipeline.py` | 3-영역 예제 |
| `test_nested_structure.py` | `integration/test_algorithm.py` | 중첩 구조 |
| `verify_concentric_full.py` | `integration/test_algorithm.py` | 6-영역 검증 |
| `test_area_editor.py` | `gui/test_dialogs.py` | Area editor |
| `test_empty_area_list.py` | `gui/test_matrix_widget.py` | 빈 리스트 처리 |
| `test_step_dendro.py` | `gui/test_dendrogram_widget.py` | Dendrogram 시각화 |
| `test_dialog.py` | `gui/test_dialogs.py` | 다이얼로그 기본 |
| `test_gui_simple.py` | `gui/test_main_window.py` | 메인 윈도우 |
| `test_merge_radii.py` | `unit/test_acc_core_new.py` | Radii merge |
| `test_pyqt5.py` | 삭제 | 환경 테스트 불필요 |
| `test_matplotlib_qt5.py` | 삭제 | 환경 테스트 불필요 |
| `test_canvas_import.py` | 삭제 | 환경 테스트 불필요 |
| `test_clustering_steps.py` | `gui/test_dendrogram_widget.py` | Clustering manager |
| `test_acc_with_log.py` | 삭제 | 로깅은 실행 중 확인 |

---

## pytest 설정

### conftest.py

```python
import pytest
import pandas as pd
from pathlib import Path

@pytest.fixture
def test_data_dir():
    """테스트 데이터 디렉토리"""
    return Path(__file__).parent / "test_data"

@pytest.fixture
def sample_sub_matrix(test_data_dir):
    """샘플 subordinate matrix (6-영역)"""
    df = pd.read_csv(test_data_dir / "sample_subordinate.csv", index_col=0)
    return {idx: dict(row) for idx, row in df.iterrows()}

@pytest.fixture
def sample_inc_matrix(test_data_dir):
    """샘플 inclusive matrix (6-영역)"""
    df = pd.read_csv(test_data_dir / "sample_inclusive.csv", index_col=0)
    return {idx: dict(row) for idx, row in df.iterrows()}

@pytest.fixture
def simple_abc_matrix():
    """간단한 3-영역 테스트용"""
    return {
        "A": {"B": 0.9, "C": 0.5},
        "B": {"A": 0.9, "C": 0.5},
        "C": {"A": 0.5, "B": 0.5}
    }

@pytest.fixture
def invalid_asymmetric_matrix():
    """비대칭 matrix (테스트용)"""
    return {
        "A": {"B": 0.9},
        "B": {"A": 0.8}  # 비대칭
    }

@pytest.fixture
def qapp(qapp):
    """PyQt5 QApplication (pytest-qt 제공)"""
    return qapp
```

### pytest.ini

```ini
[pytest]
testpaths = tests
python_files = test_*.py
python_classes = Test*
python_functions = test_*
addopts =
    -v
    --strict-markers
    --tb=short
    --cov=.
    --cov-report=html
    --cov-report=term-missing
markers =
    unit: Unit tests
    integration: Integration tests
    gui: GUI tests
    slow: Slow running tests
    performance: Performance benchmarks
```

### requirements-dev.txt

```
pytest>=7.4.0
pytest-qt>=4.2.0
pytest-cov>=4.1.0
pytest-mock>=3.11.0
pytest-benchmark>=4.0.0
```

---

## GitHub Actions Workflow

**.github/workflows/test.yml**:

```yaml
name: Tests

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.8', '3.9', '3.10', '3.11']

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt

    - name: Run unit tests
      run: pytest tests/unit -v --cov=. --cov-report=xml

    - name: Run integration tests
      run: pytest tests/integration -v

    - name: Run GUI tests
      run: pytest tests/gui -v
      env:
        QT_QPA_PLATFORM: offscreen

    - name: Upload coverage
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
```

---

## 작업 단계

### Phase 1: 준비 (15분)
1. ✅ `tests/` 디렉토리 구조 생성
2. ✅ `conftest.py` 작성
3. ✅ `pytest.ini` 작성
4. ✅ 테스트 데이터 복사

### Phase 2: 단위 테스트 (1시간)
1. ✅ `test_acc_core.py` - 핵심 함수들
2. ✅ `test_acc_core_new.py` - 새 알고리즘
3. ✅ `test_acc_utils.py` - 유틸리티 함수들
4. ✅ `test_data_structures.py` - 데이터 구조

### Phase 3: 통합 테스트 (45분)
1. ✅ `test_pipeline.py` - 전체 파이프라인
2. ✅ `test_algorithm.py` - 알고리즘 검증
3. ✅ `test_validation.py` - 데이터 검증

### Phase 4: GUI 테스트 (45분)
1. ✅ `test_main_window.py`
2. ✅ `test_matrix_widget.py`
3. ✅ `test_dendrogram_widget.py`
4. ✅ `test_acc_widget.py`
5. ✅ `test_dialogs.py`

### Phase 5: CI/CD 및 마무리 (30분)
1. ✅ GitHub Actions workflow 작성
2. ✅ README에 테스트 배지 추가
3. ✅ 전체 테스트 실행 및 검증
4. ✅ 커버리지 확인 (목표: 80%+)
5. ✅ 기존 테스트 파일 정리

---

## 예상 결과

### 통계
- **테스트 파일**: 약 15개
- **테스트 케이스**: 100+ 개
- **코드 커버리지**: 80%+ 목표
- **실행 시간**: < 30초 (GUI 제외)

### 품질 지표
- ✅ 모든 핵심 함수 테스트
- ✅ Edge case 처리 검증
- ✅ 오류 처리 검증
- ✅ GUI 기본 동작 검증
- ✅ CI/CD 자동화

### 유지보수성
- ✅ 일관된 구조
- ✅ 명확한 네이밍
- ✅ Fixture 재사용
- ✅ 문서화된 테스트
- ✅ 쉬운 추가/수정

---

## 참고사항

### 테스트 작성 원칙

1. **AAA 패턴**: Arrange, Act, Assert
2. **독립성**: 각 테스트는 독립적
3. **명확성**: 테스트 이름으로 의도 파악
4. **반복성**: 동일 결과 보장
5. **빠른 실행**: 단위 테스트는 빠르게

### 테스트 네이밍

```python
def test_<function>_<scenario>_<expected>():
    """
    테스트 대상 함수의 시나리오와 예상 결과를 명확히
    """
    pass

# 예시
def test_validate_similarity_matrix_asymmetric_returns_false():
    """비대칭 matrix는 검증 실패를 반환한다"""
    pass

def test_build_acc_iterative_6_areas_creates_correct_steps():
    """6-영역 데이터로 ACC 빌드 시 올바른 단계 생성"""
    pass
```

### GUI 테스트 주의사항

- `pytest-qt` 사용
- QApplication fixture 필요
- CI에서는 `QT_QPA_PLATFORM=offscreen`
- 시각적 검증은 수동

---

## 다음 단계

1. Phase 1부터 순차 진행
2. 각 Phase 완료 후 테스트 실행 확인
3. 커버리지 측정 및 개선
4. GitHub Actions 통합
5. 문서 업데이트

---

## 예상 시간

- **계획 및 문서화**: 30분 ✅
- **Phase 1 (준비)**: 15분
- **Phase 2 (단위)**: 1시간
- **Phase 3 (통합)**: 45분
- **Phase 4 (GUI)**: 45분
- **Phase 5 (CI/CD)**: 30분
- **총**: 약 3.5시간

---

## 성공 기준

- [x] 모든 기존 테스트 기능 보존
- [ ] pytest 실행 성공
- [ ] 커버리지 80% 이상
- [ ] CI/CD 통과
- [ ] 문서화 완료
