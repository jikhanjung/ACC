# 20251111 P02: 3단계 워크플로우 구현

## 개요

GUI를 3단계 워크플로우로 재설계하여 각 similarity matrix를 dendrogram으로 먼저 시각화한 후 ACC 결과를 생성하도록 변경.

## 변경 사항

### 1. 워크플로우 재설계

**이전**: Matrix 입력 → 바로 ACC 생성

**변경 후**: 3단계 프로세스
1. **Step 1**: Subordinate Matrix 로드 → Dendrogram 시각화
2. **Step 2**: Inclusive Matrix 로드 → Dendrogram 시각화
3. **Step 3**: Generate 버튼 → ACC Concentric Circles 시각화

### 2. 새로운 컴포넌트

#### DendrogramWidget
- scipy의 `dendrogram()` 함수 사용
- Similarity matrix를 distance matrix로 변환 (distance = 1 - similarity)
- Hierarchical clustering 결과를 트리 형태로 시각화
- Orientation: 'right' (오른쪽으로 확장)

#### 업데이트된 MatrixInputWidget
- Matrix 테이블 표시 (최대 높이 150px로 제한)
- **DendrogramWidget 추가**: CSV 로드 시 자동으로 dendrogram 생성
- 상태 표시: "⚠ No data loaded" → "✓ Loaded: NxN matrix"

#### VisualizationWidget
- 기존 concentric circles 시각화 유지
- Step 3 제목 추가
- 색상 개선 (Set3 colormap 사용)

### 3. UI 개선사항

#### 레이아웃
- 왼쪽 패널: Scrollable (긴 콘텐츠 지원)
- 오른쪽 패널: ACC 시각화
- 비율: 2:3

#### 스타일링
- Step 구분을 위한 색상 코딩 (#1976D2)
- 버튼 스타일 개선 (hover/pressed 효과)
- 상태 아이콘 추가 (⚠ / ✓)
- Separator (구분선) 추가

### 4. 버그 수정

#### 문제: 모든 점이 원점에 모임

**원인**:
- scipy의 hierarchical clustering은 개별 리프 노드(`sim=1.0`)를 생성
- `extract_clusters_from_dendro`가 단일 멤버 클러스터도 포함
- `sim_sub` 정렬 시 단일 멤버가 먼저 와서 알고리즘 오작동

**해결**:
1. `extract_clusters_from_dendro_filtered()` 함수 추가 (acc_utils.py)
   - 2개 이상의 멤버를 가진 클러스터만 추출
2. `build_acc_from_matrices()` 통합 함수 추가
   - Matrix → Dendrogram → Filtered Clusters → ACC 결과
   - 전체 파이프라인을 하나의 함수로 처리

**결과**:
```
이전: 모든 점이 (0, 0)에 위치
변경 후:
  J: (1.3977, -0.2214)
  N: (1.2066, -0.7394)
  O: (1.1448, -0.8318)
  Q: (1.3977, -0.2214)
  T: (1.3977, 0.2214)
  Y: (1.2609, 0.6424)
```

## 기술적 세부사항

### Dendrogram 생성 과정

```python
# 1. Similarity → Distance 변환
distance_array = 1.0 - similarity_array

# 2. Condensed distance matrix 생성 (scipy 요구사항)
condensed_dist = squareform(distance_matrix)

# 3. Hierarchical clustering 수행
linkage_matrix = linkage(condensed_dist, method='average')

# 4. Dendrogram 그리기
dendrogram(linkage_matrix, labels=labels, orientation='right')
```

### ACC 생성 최적화

```python
# 기존 (문제 있음)
sub_dendro = matrix_to_dendrogram(sub_matrix)
clusters = extract_clusters_from_dendro(sub_dendro)  # 단일 멤버 포함!

# 수정 후 (정상 작동)
acc_result = build_acc_from_matrices(sub_matrix, inc_matrix)
# 내부에서 extract_clusters_from_dendro_filtered() 사용
```

## 파일 변경 내역

### 수정된 파일
- **acc_gui.py** (완전 재작성, ~500 라인)
  - DendrogramWidget 추가
  - 3단계 워크플로우 구현
  - ScrollArea 지원

- **acc_utils.py** (함수 추가)
  - `extract_clusters_from_dendro_filtered()`: 필터링된 클러스터 추출
  - `build_acc_from_matrices()`: 통합 빌드 함수

- **test_integration.py** (업데이트)
  - 새로운 `build_acc_from_matrices()` 사용

### 새로운 파일
- **debug_dendro.py**: Dendrogram 구조 비교 디버깅
- **test_gui_simple.py**: 간단한 검증 테스트

## 사용자 경험 개선

### Before
1. Matrix 두 개 로드
2. Generate 클릭
3. 결과가 잘못됨 (모든 점이 중심에 모임)

### After
1. **Step 1**: Subordinate CSV 로드 → Dendrogram 확인 가능
2. **Step 2**: Inclusive CSV 로드 → Dendrogram 확인 가능
3. **Step 3**: Generate 클릭 → 제대로 분산된 ACC 시각화
4. 각 단계에서 명확한 피드백 제공

## 테스트 결과

### Integration Test
```bash
$ python test_integration.py
✓ Matrix validation: PASS
✓ Dendrogram conversion: PASS
✓ ACC algorithm: PASS
✓ Points distribution: PASS (6 members, properly distributed)
```

### GUI Test
```bash
$ python acc_gui.py
✓ Subordinate dendrogram: 표시됨
✓ Inclusive dendrogram: 표시됨
✓ ACC visualization: 정상 작동
```

## 다음 단계 제안

### Phase 2 기능
- [ ] Dendrogram에서 클러스터 선택/하이라이트
- [ ] Linkage method 선택 (average, single, complete, ward)
- [ ] Unit 파라미터 조정 슬라이더
- [ ] Export 기능 (PNG, SVG, PDF)
- [ ] 여러 데이터셋 비교

### UI/UX 개선
- [ ] 다크 모드 지원
- [ ] 확대/축소 기능
- [ ] 애니메이션 효과
- [ ] Undo/Redo 기능
- [ ] 최근 파일 목록

### 성능 최적화
- [ ] 대규모 데이터셋 (100+ items) 지원
- [ ] 백그라운드 처리 (QThread)
- [ ] 캐싱 메커니즘
- [ ] 프로그레스 바 추가

## 결론

3단계 워크플로우를 통해:
1. 사용자가 각 단계에서 데이터를 확인 가능
2. Dendrogram으로 클러스터링 결과를 먼저 검증
3. 버그가 수정되어 ACC 시각화가 정상 작동
4. 더 직관적이고 투명한 사용자 경험 제공

모든 기능이 정상 작동하며, 샘플 데이터로 테스트 완료.
