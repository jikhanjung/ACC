# P36: Undo/Redo, 헤더 드래그 정렬, 예외 처리

**작성일**: 2026-02-11
**상태**: 완료
**구현 기록**: [039](20260211_039_Undo_Redo_헤더드래그_구현.md)
**선행 작업**: P34 (Raw Data Panel), P35 (유사도 계산 연동) — 완료

---

## 1. 목표

DataPanel/PresenceAbsenceTable에 다음 기능 추가:
1. **Undo/Redo**: Ctrl+Z / Ctrl+Shift+Z로 모든 편집 작업 되돌리기
2. **헤더 드래그 정렬**: 행/열 헤더를 드래그하여 순서 변경
3. **예외 처리 강화**: 유사도 계산 시 빈 데이터 경고
4. `.accdata`를 `.gitignore`에 추가

## 2. Undo/Redo 시스템

### 2.1 아키텍처

```
DataPanel
├── undo_stack: QUndoStack (모든 시트 공유)
├── Sheet "Cambrian" → PresenceAbsenceTable
│     └── 각 편집 작업 → QUndoCommand → undo_stack.push()
├── Sheet "Ordovician" → PresenceAbsenceTable
│     └── 각 편집 작업 → QUndoCommand → undo_stack.push()
└── Global (read-only, undo 대상 아님)
```

- `QUndoStack`은 DataPanel에 1개만 존재 (모든 시트가 공유)
- `QUndoStack.push(cmd)`가 호출되면 `cmd.redo()`가 자동 실행됨
- 기존 직접 변경 코드를 Command의 `redo()`로 이동

### 2.2 QUndoCommand 서브클래스

| 클래스 | 범위 | 추적 데이터 |
|--------|------|-------------|
| `CellChangeCommand` | 단일 테이블 | (row, col, old_val, new_val) |
| `BulkCellChangeCommand` | 단일 테이블 | [(row, col, old, new), ...] |
| `AddAreaCommand` | 전체 시트 동기화 | (at_row, area_name) |
| `DeleteAreaCommand` | 전체 시트 동기화 | (row, name, per_sheet_row_data) |
| `RenameAreaCommand` | 전체 시트 동기화 | (row, old_name, new_name) |
| `AddTaxonCommand` | 단일 테이블 | (at_col, taxon_name) |
| `DeleteTaxonCommand` | 단일 테이블 | (col, name, col_data) |
| `RenameTaxonCommand` | 단일 테이블 | (col, old_name, new_name) |
| `ReorderRowCommand` | 전체 시트 동기화 | (old_index, new_index) |
| `ReorderColumnCommand` | 단일 테이블 | (old_index, new_index) |
| `PasteTableCommand` | 단일 테이블 | (old_state, new_state) via get_data/set_data |

### 2.3 이전 값 추적

`PresenceAbsenceTable`에 `_cell_values: dict[(row,col), int]`를 추가하여 셀 변경 전 값을 추적한다. `_set_cell()` 호출 시 자동 갱신.

`_on_cell_changed` (사용자가 셀에 직접 타이핑)에서는:
1. `_cell_values`에서 이전 값 조회
2. 새 값과 다르면 `CellChangeCommand` push
3. `_set_cell` → `blockSignals(True)` 이므로 undo/redo의 `_set_cell`은 `cellChanged` 시그널을 발생시키지 않음

### 2.4 키보드 단축키

```python
Ctrl+Z          → undo_stack.undo()
Ctrl+Shift+Z    → undo_stack.redo()
Ctrl+Y          → undo_stack.redo() (Windows 호환)
```

`keyPressEvent`에서 `QKeySequence.Undo`, `QKeySequence.Redo` 매칭.

### 2.5 스택 초기화 시점

- `DataPanel.new_project()` — 새 프로젝트 생성 시
- `DataPanel.set_all_data()` — 파일 로드 시
- `DataPanel.delete_current_sheet()` — 시트 삭제 시 (참조 무효화 방지)

## 3. 헤더 드래그 정렬

### 3.1 구현 방식

Qt의 `QHeaderView.setSectionsMovable(True)` 사용:
- 사용자가 헤더를 드래그하면 `sectionMoved(logical, oldVisual, newVisual)` 시그널 발생
- 핸들러에서 visual move를 즉시 되돌리고, 대신 데이터를 물리적으로 재정렬

### 3.2 행(Area) 이동 — 전체 시트 동기화

```
1. 사용자가 행 헤더를 드래그 → sectionMoved 시그널
2. 핸들러: header.moveSection()으로 visual 원복
3. ReorderRowCommand push → 모든 시트에서 해당 행 이동
4. areas 리스트도 함께 갱신
```

### 3.3 열(Taxon) 이동 — 해당 시트만

```
1. 사용자가 열 헤더를 드래그 → sectionMoved 시그널
2. 핸들러: header.moveSection()으로 visual 원복
3. ReorderColumnCommand push → 해당 테이블만 열 이동
4. taxa 리스트도 함께 갱신
```

### 3.4 Global 탭

Global 탭의 테이블은 read-only이므로 `setSectionsMovable(False)` 설정.

## 4. 예외 처리 강화

### 4.1 빈 Area 경고

`calculate_similarity`에서 모든 taxa가 0인 area가 있으면:
```
"Area_X has no taxa present (all zeros).
These areas will have 0.0 similarity to all others.
Continue anyway?"
```

### 4.2 빈 Sheet 경고

Global 유사도 계산 시 데이터 없는 sheet가 있으면 info 메시지.

### 4.3 결과 검증

`validate_similarity_matrix()`로 계산된 local/global 매트릭스 검증.
(대칭성, 대각선 1.0, 값 범위 0~1)

## 5. .gitignore

`*.accdata`를 프로젝트별 섹션에 추가.

## 6. 수정 대상 파일

| 파일 | 변경 내용 |
|------|----------|
| `acc_gui.py` | QUndoCommand 서브클래스 11개 추가 |
| `acc_gui.py` | PresenceAbsenceTable: undo 연동, 헤더 드래그, _cell_values 추적 |
| `acc_gui.py` | DataPanel: QUndoStack, sync 메서드 command화, 예외 처리 |
| `.gitignore` | `*.accdata` 추가 |
