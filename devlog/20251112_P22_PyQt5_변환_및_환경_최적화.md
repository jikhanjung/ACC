# P22: PyQt5 변환 및 환경 최적화

**날짜**: 2025-11-12
**작업자**: Claude
**관련 파일**: acc_gui.py, requirements.txt, environment.yml, SETUP_PYTHON311.md

## 문제 상황

1. **PyInstaller DLL 로딩 이슈**: PyQt6로 빌드한 실행 파일이 DLL 로딩 문제로 실행되지 않음
2. **Python 3.14 호환성**: 너무 최신 버전이라 matplotlib 등 주요 패키지의 바이너리가 없음
3. **matplotlib + NumPy 2.x 충돌**: matplotlib 3.7.1이 NumPy 1.x로 컴파일되어 NumPy 2.x와 호환되지 않음
4. **PyQt5-sip DeprecationWarning**: PyQt5-sip 12.17.1이 PyQt5 5.15.9보다 최신이라 경고 발생

## 해결 방법

### 1. PyQt6 → PyQt5 변환

**변경 이유**: PyInstaller가 PyQt5에서 더 안정적으로 작동

**주요 변경 사항**:
```python
# Import 경로
from PyQt6.QtWidgets import ... → from PyQt5.QtWidgets import ...
from PyQt6.QtCore import ... → from PyQt5.QtCore import ...

# Enum 문법
Qt.Orientation.Horizontal → Qt.Horizontal
Qt.GlobalColor.lightGray → Qt.lightGray
Qt.ItemFlag.ItemIsEditable → Qt.ItemIsEditable
Qt.AlignmentFlag.AlignCenter → Qt.AlignCenter
QSlider.TickPosition.TicksBelow → QSlider.TicksBelow

# Dialog 실행
dialog.exec() → dialog.exec_()
QDialog.DialogCode.Accepted → QDialog.Accepted

# 이벤트 루프
app.exec() → app.exec_()
```

**파일 업데이트**:
- `acc_gui.py`: 전체 PyQt5 문법으로 변환
- `requirements.txt`: PyQt6 → PyQt5==5.15.9
- `requirements_frozen.txt`: 테스트된 버전으로 업데이트

### 2. Python 3.11 환경 권장

**변경 이유**: Python 3.14는 너무 최신이라 많은 패키지의 pre-built 바이너리가 없음

**새로운 환경 설정 파일**:
- `environment.yml`: conda 환경 정의 파일
- `setup_py311_env.bat`: 자동 설치 스크립트
- `SETUP_PYTHON311.md`: 상세한 설정 가이드

**권장 환경**:
```yaml
Python: 3.11
PyQt5: 5.15.9
PyQt5-sip: 12.12.2
NumPy: 2.0.0+
matplotlib: 3.9.0+
scipy: 1.11.0+
pandas: 2.0.0+
pyinstaller: 5.13.0+
```

**conda 환경 생성**:
```bash
conda env create -f environment.yml
conda activate ACC_py311
```

### 3. matplotlib NumPy 2.x 호환성

**문제**:
```
A module that was compiled using NumPy 1.x cannot be run in
NumPy 2.3.4 as it may crash.
```

**해결**:
- matplotlib 3.7.1 (NumPy 1.x로 컴파일) → matplotlib 3.9.0+ (NumPy 2.x 호환)
- requirements.txt 업데이트: `matplotlib>=3.9.0`

**import 순서 최적화**:
```python
import os
os.environ['QT_API'] = 'pyqt5'

import matplotlib
matplotlib.use('Qt5Agg')

from matplotlib.figure import Figure
import matplotlib.pyplot as plt
from matplotlib.backends.backend_qt5agg import FigureCanvasQTAgg as FigureCanvas
```

### 4. PyQt5-sip DeprecationWarning 제거

**경고 메시지**:
```
DeprecationWarning: sipPyTypeDict() is deprecated,
the extension module should use sipPyTypeDictRef() instead
```

**해결**: PyQt5-sip 12.17.1 → 12.12.2로 다운그레이드

**업데이트된 파일**:
- `requirements.txt`: PyQt5-sip==12.12.2 추가
- `requirements_frozen.txt`: 버전 고정
- `environment.yml`: pip으로 PyQt5-sip 설치하도록 수정

## 추가 기능: Show Log

**새 기능**: ACC 생성 과정의 상세 로그를 GUI에서 확인

**구현 내용**:
1. **LogViewerDialog**: 로그를 표시하는 다이얼로그
   - 모노스페이스 폰트 (Courier New, 12px)
   - "Copy to Clipboard" 버튼
   - "Save to File" 버튼
   - 읽기 전용 QTextEdit

2. **Show Log 버튼**: Generate ACC 버튼 옆에 추가
   - ACC 생성 전: 비활성화
   - ACC 생성 후: 자동 활성화

3. **로그 캡처 메커니즘**:
```python
# StringIO로 로그 캡처
log_stream = StringIO()
log_handler = logging.StreamHandler(log_stream)
logger = logging.getLogger('ACC_Iterative')
logger.addHandler(log_handler)

# ACC 생성
acc_steps = build_acc_from_matrices_iterative(...)

# 로그 저장
self.acc_log = log_stream.getvalue()
self.right_panel.show_log_btn.setEnabled(True)
```

**로그에 포함되는 정보**:
- 전체 영역 수와 이름
- 각 스텝별 선택된 pair/cluster
- Local/Global similarity 값
- 계산된 radius, diameter, angle
- 각 영역의 좌표 (x, y)
- 클러스터 병합 정보

## 코드 정리

**디버그 코드 제거**:
- 임포트 시 디버그 print 문 (11개)
- MainWindow 초기화 디버그 메시지 (6개)
- main() 함수 디버그 메시지 (6개)
- 기타 __name__ 확인 메시지 (2개)

**총 25개의 디버그 print 문 제거**

## 파일 변경 이력

### 새로 생성된 파일
- `environment.yml`: conda 환경 정의
- `setup_py311_env.bat`: 자동 설치 스크립트
- `SETUP_PYTHON311.md`: Python 3.11 환경 설정 가이드
- `test_canvas_import.py`: matplotlib+PyQt5 테스트 스크립트
- `check_pyqt5_details.py`: PyQt5 설치 확인 스크립트
- `MATPLOTLIB_ISSUE.md`: matplotlib 이슈 문서
- `fix_matplotlib_conda.bat`: matplotlib 수정 스크립트

### 수정된 파일
- `acc_gui.py`:
  - PyQt6 → PyQt5 전환
  - LogViewerDialog 클래스 추가
  - Show Log 버튼 추가
  - 로그 캡처 로직 추가
  - 디버그 코드 제거

- `requirements.txt`:
  - PyQt5==5.15.9
  - PyQt5-sip==12.12.2
  - matplotlib>=3.9.0
  - numpy>=2.0.0

- `requirements_frozen.txt`: 테스트된 버전으로 업데이트

## 테스트 결과

### 성공한 테스트
✅ PyQt5 5.15.9 설치 확인
✅ matplotlib 3.9.0 + NumPy 2.3.4 호환성 확인
✅ FigureCanvasQTAgg import 성공
✅ GUI 정상 실행
✅ ACC 생성 정상 작동
✅ Show Log 기능 작동
✅ DeprecationWarning 제거 확인

### 최종 환경
```
Python: 3.11
PyQt5: 5.15.9
PyQt5-sip: 12.12.2
Qt5: 5.15.2
matplotlib: 3.9.0+
NumPy: 2.3.4
scipy: 1.13.1
pandas: 2.2.2
```

## 빌드 명령어

### 개발 환경 실행
```bash
conda activate ACC_py311
python acc_gui.py
```

### PyInstaller 빌드
```bash
conda activate ACC_py311
cd D:\projects\ACC
pyinstaller --name "ACCViz_v0.0.1_py311" --onefile --noconsole acc_gui.py
```

## 다음 단계

1. ✅ PyQt5 환경 안정화
2. ✅ 패키지 호환성 확인
3. ✅ GUI 기능 검증
4. ⏭️ PyInstaller 빌드 테스트
5. ⏭️ 빌드된 실행 파일 배포 테스트

## 참고 문서

- SETUP_PYTHON311.md: Python 3.11 환경 설정 가이드
- MATPLOTLIB_ISSUE.md: matplotlib 호환성 이슈 해결
- TROUBLESHOOT_PYQT5.md: PyQt5 일반 문제 해결 (WSL 관련)

## 주요 교훈

1. **PyQt 버전**: PyInstaller는 PyQt5에서 더 안정적
2. **Python 버전**: 너무 최신 버전(3.14)은 패키지 생태계가 준비되지 않음
3. **바이너리 호환성**: 컴파일된 패키지(matplotlib, numpy)는 버전 매칭이 중요
4. **로깅**: GUI 애플리케이션에서 내부 프로세스를 사용자에게 보여주는 것이 유용
5. **문서화**: 환경 설정 과정을 문서화하면 재현성이 높아짐
