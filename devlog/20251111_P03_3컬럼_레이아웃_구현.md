# 20251111 P03: 3컬럼 레이아웃 및 Similarity Matrix 처리 개선

## 개요

GUI를 3컬럼 레이아웃으로 재설계하고, similarity matrix를 distance로 제대로 변환하도록 수정.

## 변경 사항

### 1. 레이아웃 재설계: 3컬럼

**이전**: 좌측 (매트릭스 + 덴드로그램 세로 배치) + 우측 (ACC 시각화)

**변경 후**: 3개 컬럼 균등 분할
- **왼쪽 컬럼**: Similarity Matrices
  - Local Matrix 테이블
  - Global Matrix 테이블
- **가운데 컬럼**: Cluster Dendrograms
  - Local Dendrogram
  - Global Dendrogram
- **오른쪽 컬럼**: ACC Visualization
  - Generate 버튼
  - Concentric Circles 시각화

### 2. Similarity to Distance 변환 수정

#### 문제점
이전에는 `distance = 1 - similarity`로 변환했으나, 이는 similarity 범위가 [0, 1]일 때만 정확합니다.

#### 해결
**올바른 변환**:
```python
distance = max(similarity) - similarity
```

이유:
- Similarity가 높을수록 (큰 값) = 더 비슷함 = distance가 작아야 함
- Similarity가 낮을수록 (작은 값) = 덜 비슷함 = distance가 커야 함
- `max - similarity`는 이 관계를 정확히 보존

#### 역변환
Dendrogram에서 DendroNode로 변환 시:
```python
similarity = max_similarity - distance
```

### 3. 코드 구조 개선

#### 새로운 위젯 클래스
- **MatrixTableWidget**: Matrix 테이블 표시 및 로딩
- **DendrogramWidget**: Dendrogram 시각화
- **ACCVisualizationWidget**: ACC Concentric Circles
- **ColumnPanel**: 각 컬럼의 베이스 클래스
- **LeftPanel, CenterPanel, RightPanel**: 각 컬럼 구현

#### 자동 업데이트
Matrix 로딩 시 자동으로 dendrogram 업데이트:
```python
def on_matrix_loaded(self):
    main_window = self.window()
    if isinstance(main_window, MainWindow):
        main_window.update_dendrograms()
```

### 4. acc_utils.py 수정

#### similarity_to_distance()
```python
# 이전
distance_matrix = 1.0 - sim_array

# 변경 후
max_sim = np.max(sim_array)
distance_matrix = max_sim - sim_array
```

#### linkage_to_dendronode()
```python
# max_sim 파라미터 추가
def linkage_to_dendronode(linkage_matrix, labels, max_sim=1.0):
    ...
    # 이전
    sim = 1.0 - dist

    # 변경 후
    sim = max_sim - dist
```

#### matrix_to_dendrogram()
```python
# max_sim 계산 및 전달
if isinstance(similarity_matrix, dict):
    values = [v for row in similarity_matrix.values() for v in row.values()]
    max_sim = max(values) if values else 1.0
else:
    max_sim = np.max(np.array(similarity_matrix))

dendro_node = linkage_to_dendronode(linkage_matrix, labels, max_sim=max_sim)
```

## UI 개선사항

### 레이아웃
- 3개 컬럼 균등 분할 (stretch=1:1:1)
- 각 컬럼 스크롤 가능 (QScrollArea)
- 깔끔한 섹션 구분 (제목, 구분선)

### 스타일링
- 컬럼 제목: 파란색 (#1976D2)
- 섹션 구분: `<hr>` 태그
- 버튼: 색상 구분 (파란색=Load, 초록색=Generate)
- 대각선 하이라이트: Matrix 테이블에서 회색 배경
- 폰트 크기 조정: 가독성 향상

### 반응형
- 윈도우 크기: 1800×900 (3컬럼에 적합)
- 각 위젯 크기 조정 가능
- 스크롤로 긴 내용 지원

## 테스트 결과

### Integration Test
```bash
$ python test_integration.py
✓ Matrix loading: PASS
✓ Validation: PASS
✓ Dendrogram conversion: PASS
✓ ACC generation: PASS
✓ Points properly distributed
```

### 결과 확인
```
Members: {'T', 'N', 'O', 'J', 'Y', 'Q'}
Diameter: 2.8302
Theta: 18.00°

Member positions:
  J: (1.3977, 0.2214)
  N: (1.0760, -0.9190)
  O: (1.3458, -0.4373)
  Q: (1.3977, 0.2214)
  T: (1.3977, -0.2214)
  Y: (1.3977, 0.2214)
```

점들이 제대로 분산되어 있음.

## 주요 특징

### 1. 직관적 워크플로우
1. 왼쪽에서 matrix 로드
2. 가운데에서 자동으로 dendrogram 생성 및 확인
3. 오른쪽에서 ACC 생성

### 2. 실시간 피드백
- Matrix 로드 즉시 dendrogram 업데이트
- 각 단계별 상태 표시 (✓/⚠)
- 명확한 에러 메시지

### 3. 데이터 검증
- Matrix validation
- 대칭성 확인
- 대각선 값 확인
- 크기 일치 확인

## 기술적 세부사항

### Similarity vs Distance

**Similarity Matrix 특성**:
- 값이 클수록 더 비슷함 (1.0 = 동일, 0.0 = 완전히 다름)
- 대각선은 1.0 (자기 자신)
- 대칭 행렬

**Distance Matrix 특성**:
- 값이 클수록 더 다름
- 대각선은 0.0
- 대칭 행렬

**변환**:
```
distance = max(similarity) - similarity
```

**예시**:
```
Similarity: [1.0, 0.8, 0.5]
max = 1.0
Distance:   [0.0, 0.2, 0.5]
```

### Scipy Hierarchical Clustering

```python
# 1. Condensed distance matrix
condensed_dist = squareform(distance_matrix)

# 2. Linkage (method='average')
linkage_matrix = linkage(condensed_dist, method='average')

# 3. Dendrogram visualization
dendrogram(linkage_matrix, labels=labels, orientation='right')
```

## 비교: 이전 vs 현재

### 레이아웃
| 항목 | 이전 | 현재 |
|------|------|------|
| 컬럼 수 | 2 (좌/우) | 3 (좌/중/우) |
| Matrix 위치 | 좌측 세로 배치 | 왼쪽 컬럼 |
| Dendrogram 위치 | 좌측 (matrix 아래) | 가운데 컬럼 (독립) |
| ACC 위치 | 우측 | 오른쪽 컬럼 |
| 가시성 | Matrix와 Dendrogram 혼재 | 각각 독립 컬럼 |

### Similarity 변환
| 항목 | 이전 | 현재 |
|------|------|------|
| 변환 공식 | `1 - similarity` | `max - similarity` |
| 역변환 | `1 - distance` | `max - distance` |
| 정확도 | [0,1] 범위만 정확 | 모든 범위 정확 |
| Max 전달 | ❌ | ✅ |

## 사용자 워크플로우

### Step 1: 왼쪽 컬럼
1. "Load CSV" 버튼 → Local matrix 로드
2. Matrix 테이블 확인
3. "Load CSV" 버튼 → Global matrix 로드
4. Matrix 테이블 확인

### Step 2: 가운데 컬럼 (자동)
1. Local dendrogram 자동 생성
2. Global dendrogram 자동 생성
3. 클러스터 구조 시각적 확인

### Step 3: 오른쪽 컬럼
1. "Generate ACC" 버튼 클릭
2. Concentric circles 시각화 생성
3. 결과 확인

## 다음 단계

### Phase 3 기능
- [ ] Linkage method 선택 UI (average, single, complete, ward)
- [ ] Unit 파라미터 슬라이더
- [ ] Dendrogram에서 클러스터 선택
- [ ] 선택한 클러스터 하이라이트
- [ ] Export 기능 (PNG, SVG, PDF)

### 성능 최적화
- [ ] 대규모 데이터셋 (50+ items) 처리
- [ ] QThread로 백그라운드 처리
- [ ] Progress bar 추가

### 시각화 개선
- [ ] Dendrogram 색상 테마
- [ ] ACC 애니메이션
- [ ] 확대/축소 기능
- [ ] 멤버 클릭 시 정보 표시

## 결론

3컬럼 레이아웃으로:
1. **명확한 정보 구조**: Matrix → Dendrogram → ACC
2. **더 나은 가시성**: 각 단계가 독립적으로 표시
3. **올바른 Similarity 처리**: `max - similarity` 변환
4. **자동 업데이트**: Matrix 로드 시 dendrogram 자동 생성

모든 기능이 정상 작동하며, 샘플 데이터로 테스트 완료.
