# 39: Undo/Redo, 헤더 드래그 정렬, 예외 처리 구현 결과

**작성일**: 2026-02-11
**관련 계획**: P36

---

## 구현 내용

### 1. Undo/Redo 시스템

`QUndoStack` + `QUndoCommand` 패턴으로 모든 편집 작업에 대한 되돌리기/다시하기 구현.

**QUndoCommand 서브클래스 11개:**

| 클래스 | 범위 | 설명 |
|--------|------|------|
| `CellChangeCommand` | per-table | 셀 값 0↔1 변경 |
| `BulkCellChangeCommand` | per-table | Fill Selection (다수 셀 일괄 변경) |
| `AddAreaCommand` | 전체 시트 | Area 추가 (모든 시트 동기화) |
| `DeleteAreaCommand` | 전체 시트 | Area 삭제 (per-sheet 데이터 스냅샷 저장) |
| `RenameAreaCommand` | 전체 시트 | Area 이름 변경 |
| `AddTaxonCommand` | per-table | Taxon 열 추가 |
| `DeleteTaxonCommand` | per-table | Taxon 열 삭제 (열 데이터 스냅샷) |
| `RenameTaxonCommand` | per-table | Taxon 이름 변경 |
| `ReorderRowCommand` | 전체 시트 | 행 순서 변경 |
| `ReorderColumnCommand` | per-table | 열 순서 변경 |
| `PasteTableCommand` | per-table | 붙여넣기 (before/after 전체 테이블 스냅샷) |

**구현 세부사항:**
- `DataPanel.undo_stack`: 모든 시트가 공유하는 단일 QUndoStack
- `PresenceAbsenceTable._cell_values`: `{(row, col): value}` 딕셔너리로 이전 값 추적
- `_undo_guard` 플래그로 `_on_cell_changed` → `CellChangeCommand` 재귀 방지
- `Ctrl+Z` / `Ctrl+Shift+Z(Ctrl+Y)` 단축키 지원
- 스택 초기화: `new_project()`, `set_all_data()`, `delete_current_sheet()` 시 `clear()`

### 2. 헤더 드래그 정렬

- `verticalHeader().setSectionsMovable(True)` — 행 헤더 드래그 활성화
- `horizontalHeader().setSectionsMovable(True)` — 열 헤더 드래그 활성화
- `_on_row_moved()`: visual move를 즉시 되돌린 뒤 `ReorderRowCommand` push (전체 시트 동기화)
- `_on_column_moved()`: visual move를 즉시 되돌린 뒤 `ReorderColumnCommand` push (해당 시트만)
- Global 탭: `setSectionsMovable(False)` 설정하여 비활성화

### 3. 유사도 계산 경고/예외 처리

`calculate_similarity()`에 3가지 검증 추가:

1. **빈 Area 경고**: 모든 taxa가 0인 area 감지 → Yes/No 확인 대화상자
2. **빈 Sheet 안내**: 데이터 없는 시트가 있으면 정보 메시지 표시
3. **결과 검증**: `validate_similarity_matrix()`로 local/global 매트릭스 유효성 확인

### 4. .gitignore

`*.accdata` 패턴을 "Project specific" 섹션에 추가.

## 수정된 파일

| 파일 | 변경 내용 |
|------|----------|
| `acc_gui.py` | QUndoCommand 11개 클래스 추가, PresenceAbsenceTable/DataPanel 수정 |
| `.gitignore` | `*.accdata` 추가 |

## 기술 노트

- `QUndoStack.push(cmd)`는 자동으로 `cmd.redo()`를 호출하므로, 기존 직접 변경 코드를 제거하고 Command의 `redo()`에서 실행하도록 변경
- `PasteTableCommand`는 before/after 전체 스냅샷 방식이므로 push 시 `redo()`가 중복 적용되나 `set_data()`가 멱등(idempotent)이므로 무해
- `_set_cell()`의 `blockSignals(True)` 덕분에 undo/redo 시 `cellChanged` 시그널 순환 없음
