# 20251111 P04: 단계별 클러스터링 시각화 구현

## 개요

계층적 클러스터링의 각 단계를 시각화하는 기능 추가:
- 원본 matrix (Step 0)
- Step 1: 첫 번째 병합 (예: J+T)
- Step 2: 두 번째 병합 (예: O+Q)
- ...
- Step n: 최종 병합

각 단계마다:
- 축소된 similarity matrix 표시
- 부분 dendrogram 표시 (해당 단계까지만)
- 슬라이더/버튼으로 단계 이동

## 구현 내용

### 1. ClusteringStepManager 클래스 (clustering_steps.py)

계층적 클러스터링의 모든 단계를 관리하는 핵심 클래스.

#### 주요 기능

**초기화 (__init__)**:
```python
def __init__(self, similarity_matrix, labels):
    # 1. Similarity를 distance로 변환
    # 2. Hierarchical clustering 수행 (scipy.linkage)
    # 3. 모든 단계 생성 (_generate_steps)
```

**단계 생성 (_generate_steps)**:
- Step 0: 원본 matrix
- Step 1~n: 각 병합 단계마다 축소된 matrix 생성

**Matrix 병합 (_merge_matrix)**:
- 두 클러스터를 하나로 병합
- Matrix 크기 축소 (n×n → (n-1)×(n-1))
- 병합된 클러스터의 similarity는 평균값 사용

**Partial linkage (get_partial_linkage)**:
- Step i까지의 linkage matrix 반환
- Dendrogram 그리기용

#### 데이터 구조

각 step은 다음 정보를 포함:
```python
{
    'step_num': int,
    'matrix': numpy array (축소된 similarity matrix),
    'labels': list (축소된 label 리스트),
    'merged_pair': tuple (병합된 두 클러스터),
    'distance': float (병합 거리),
    'similarity': float (병합 유사도),
    'cluster_map': dict (현재 클러스터 구성)
}
```

### 2. GUI 업데이트 (acc_gui.py)

#### StepMatrixWidget

**기능**:
- Similarity matrix 표시
- Step slider (0 ~ n-1)
- Prev/Next 버튼
- 현재 단계 설명

**UI 구성**:
```
[Title] [Load CSV]
Step: 3/5
Merge (J+T) + (Y), similarity=0.800
[◀ Prev] [========•===] [Next ▶]
┌─────────────────────┐
│  Matrix Table       │
│  (축소된 matrix)    │
└─────────────────────┘
```

**특징**:
- 병합된 클러스터는 노란색 배경으로 하이라이트
- 대각선은 회색 배경
- Label은 'J+T+Y' 형식으로 표시

#### StepDendrogramWidget

**기능**:
- 부분 dendrogram 표시
- Step 0: "Original Matrix (No clustering yet)"
- Step 1~n: 해당 단계까지의 dendrogram만 표시

**구현**:
```python
def update_dendrogram(self):
    if step == 0:
        # 텍스트만 표시
    else:
        # Partial linkage matrix로 dendrogram 그리기
        partial_linkage = step_manager.get_partial_linkage(step)
        dendrogram(partial_linkage, ...)
```

### 3. 슬라이더 동작

**워크플로우**:
1. CSV 로드 → ClusteringStepManager 생성
2. Slider 범위 설정 (0 ~ num_steps-1)
3. Slider 이동 → `on_step_changed()` 호출
4. Matrix widget 업데이트
5. Dendrogram widget 업데이트 (via parent)

**동기화**:
- Subordinate와 Inclusive 각각 독립적으로 제어
- 각각의 slider로 별도 단계 탐색 가능

## 테스트 결과

### ClusteringStepManager 테스트

```bash
$ python test_clustering_steps.py

Step 0: Original matrix (6 items)
  Matrix size: (6, 6)
  Labels: ['J', 'T', 'Y', 'N', 'O', 'Q']

Step 1: Merge (J) + (T), similarity=0.900
  Matrix size: (5, 5)
  Labels: ['Y', 'N', 'O', 'Q', 'J+T']

Step 2: Merge (O) + (Q), similarity=0.850
  Matrix size: (4, 4)
  Labels: ['Y', 'N', 'J+T', 'O+Q']

Step 3: Merge (Y) + (J+T), similarity=0.800
  Matrix size: (3, 3)
  Labels: ['N', 'O+Q', 'J+T+Y']

Step 4: Merge (N) + (O+Q), similarity=0.750
  Matrix size: (2, 2)
  Labels: ['J+T+Y', 'N+O+Q']

Step 5: Merge (Y+J+T) + (N+O+Q), similarity=0.353
  Matrix size: (1, 1)
  Labels: ['J+N+O+Q+T+Y']
```

✅ Matrix가 각 단계마다 제대로 축소됨
✅ Labels가 병합되어 'J+T+Y' 형식으로 표시됨
✅ Similarity 값이 올바름

## 주요 알고리즘

### Matrix 병합 알고리즘

두 클러스터 i와 j를 병합할 때:

```python
# 1. 병합된 클러스터와 다른 클러스터 k 간의 similarity
for k in other_clusters:
    sim_merged_k = (sim_i_k + sim_j_k) / 2.0

# 2. 새 matrix 구성
new_matrix[...] = old_matrix[...]  # 기존 값 복사
new_matrix[merged_idx, k] = sim_merged_k  # 병합 클러스터 추가
new_matrix[k, merged_idx] = sim_merged_k  # 대칭
```

**특징**:
- Average linkage와 동일한 방식
- Matrix 크기: n×n → (n-1)×(n-1)
- 병합된 클러스터는 마지막 행/열에 위치

### Partial Dendrogram 그리기

```python
# linkage_matrix = [n-1 rows]
# Step i = first i rows

partial_linkage = linkage_matrix[:step_num, :]
dendrogram(partial_linkage, labels=original_labels)
```

**결과**:
- Step 1: J-T만 연결
- Step 2: J-T와 O-Q 두 개의 작은 트리
- Step 3: J-T-Y 하나의 트리 + O-Q
- ...
- Step n: 전체 dendrogram

## 사용자 경험

### Before (이전)
- Matrix 로드 → 전체 dendrogram만 표시
- 클러스터링 과정을 볼 수 없음
- 어떤 순서로 병합되는지 불명확

### After (현재)
1. Matrix 로드 → Step controls 나타남
2. **Slider/버튼으로 각 단계 탐색**
3. 각 단계마다:
   - 축소된 matrix 확인
   - 부분 dendrogram 확인
   - 병합 정보 확인 (description)
4. 클러스터링 과정을 단계별로 이해 가능

## UI 개선사항

### 시각적 피드백
- **Step label**: "Step: 3/5" (진행도 표시)
- **Description**: "Merge (J+T) + (Y), similarity=0.800"
- **하이라이트**: 병합된 클러스터 노란색 배경
- **버튼 상태**: Prev/Next 버튼 enable/disable

### 인터랙션
- **Slider**: 드래그로 연속 이동
- **Prev/Next**: 한 단계씩 이동
- **자동 동기화**: Matrix slider 이동 → Dendrogram 자동 업데이트

## 기술적 세부사항

### Linkage Matrix 구조

scipy.cluster.hierarchy.linkage 결과:
```
[
  [i, j, distance, count],  # Step 1
  [i, j, distance, count],  # Step 2
  ...
  [i, j, distance, count],  # Step n-1
]
```

- `i, j`: 병합할 클러스터 ID
- `distance`: 병합 거리
- `count`: 병합 후 멤버 수

### Cluster ID 규칙

- 0 ~ n-1: 원본 항목
- n ~ 2n-2: 병합된 클러스터
- Step i의 새 클러스터 ID = n + i

### Label 표현

병합된 클러스터 label:
```python
# tuple로 저장
label = ('J', 'T', 'Y')

# 표시할 때 join
display = '+'.join(label)  # "J+T+Y"
```

## 성능 고려사항

### 메모리
- 각 step마다 matrix 복사본 저장
- n개 항목 → n개 step → O(n³) 메모리
- 큰 데이터셋 (100+ items)은 주의 필요

### 계산
- ClusteringStepManager 초기화 시 모든 단계 사전 계산
- Slider 이동은 사전 계산된 결과만 표시 (빠름)

### 최적화 가능성
- Lazy evaluation: 필요할 때만 계산
- Matrix compression: 대칭성 활용
- Caching: 자주 사용되는 step 캐싱

## 알려진 제약사항

### 1. Matrix 병합 방식
현재 Average linkage 방식 사용:
```python
sim_merged = (sim_i + sim_j) / 2.0
```

다른 방식:
- Single linkage: `max(sim_i, sim_j)`
- Complete linkage: `min(sim_i, sim_j)`
- Ward: 분산 최소화

### 2. Label 표현
매우 큰 클러스터 (10+ items):
```
J+T+Y+N+O+Q+A+B+C+D  # 너무 길어짐
```

개선 가능:
- 줄임표: "J+T+Y+...+D (10 items)"
- 클러스터 ID: "Cluster_5 (10 items)"

## 다음 단계

### Phase 5 기능
- [ ] Animation: 자동으로 step 0 → n까지 재생
- [ ] Step 비교: 두 개 step 동시에 표시
- [ ] Export: 각 step의 matrix/dendrogram 저장
- [ ] Linkage method 선택: average, single, complete, ward

### UI 개선
- [ ] Keyboard shortcuts: ←/→ 키로 step 이동
- [ ] Jump to step: 특정 step 번호 입력
- [ ] Bookmarks: 중요한 step 표시
- [ ] Step history: 이전에 본 step 기록

### 시각화 개선
- [ ] Heatmap view: Matrix를 heatmap으로
- [ ] 3D dendrogram: 입체 시각화
- [ ] Cluster colors: 같은 클러스터 같은 색
- [ ] Transition effects: Step 전환 시 애니메이션

## 결론

단계별 클러스터링 시각화로:
1. **교육적**: 클러스터링 과정을 단계별로 학습 가능
2. **탐색적**: 각 단계에서 무슨 일이 일어나는지 확인
3. **디버깅**: 알고리즘 동작 검증에 유용
4. **인터랙티브**: Slider/버튼으로 자유롭게 탐색

모든 기능이 정상 작동하며, 샘플 데이터로 테스트 완료.
GUI를 실행하여 slider로 단계별 진행상황을 확인할 수 있습니다.
