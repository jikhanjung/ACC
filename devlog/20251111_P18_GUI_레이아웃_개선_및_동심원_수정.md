# 20251111 P18: GUI 레이아웃 개선 및 ACC 동심원 수정

## 개요

GUI 사용성 개선을 위한 레이아웃 정리 및 ACC 동심원 시각화 수정 작업.

## 작업 내역

### 1. 덴드로그램 시각화 개선 (P12-P15)

#### P12: 노드에 Similarity 값 표시
- 체크박스 추가: "Show similarity values"
- 체크 시 각 병합 노드 옆에 similarity 값 표시
- 흰색 박스에 소수점 3자리로 표시
- 위치: 각 병합 지점 바로 옆

#### P13: 소수점 자리수 통일
- Matrix: `.3f` (기존 유지)
- Dendrogram X축: `.2f` → `.3f`
- Dendrogram 노드 값: `.2f` → `.3f`
- 모든 similarity 값이 동일한 형식으로 통일

#### P14: 하이라이트 색상 및 타이밍 조정
- **색상 통일**: 프리뷰와 병합 후 모두 노란색
  - Before: 프리뷰 빨간색 → 병합 후 노란색 (혼란)
  - After: 프리뷰 노란색 → 병합 후 노란색 (일관성)
- **타이밍**: 병합 후 0.5초만 노란색 표시 후 하얀색으로 변경
  - QTimer.singleShot(500, self._remove_highlight)
- **상태 변수 추가**: `highlight_merged`, `merged_cluster_idx`

#### P15: 병합 후 올바른 위치 하이라이트
- **문제**: 첫 번째 tuple을 찾아서 잘못된 위치 하이라이트
- **해결**: preview_clusters 정보 활용
  ```python
  # preview_clusters 정보를 clear 전에 저장
  preview_idx_i, preview_idx_j = self.preview_clusters
  if preview_idx_i > preview_idx_j:
      preview_idx_i, preview_idx_j = preview_idx_j, preview_idx_i

  # 병합된 클러스터는 더 작은 인덱스 위치에
  self.merged_cluster_idx = preview_idx_i
  ```

### 2. ACC 동심원 시각화 수정 시도 (P16-P17)

#### P16: 문제 분석
- **현상**: 하나의 원에 모든 area 표시
- **원인**: `build_acc()`가 모든 클러스터를 병합하여 단일 결과 반환
- **분석**: 각 클러스터가 고유한 diameter를 가져야 하는데 병합 과정에서 정보 손실

#### P17: 다중 동심원 구현 시도
- `build_acc()` 수정: 각 클러스터를 독립적으로 배치하여 리스트 반환
  ```python
  return {
      "clusters": positioned_clusters,
      "all_members": all_members
  }
  ```
- `plot_acc_result()` 수정: 여러 개의 원 그리기
- **결과**: 모든 area가 x축 근처에 몰림
- **원인**: Text.docx의 알고리즘을 잘못 이해
  - 실제: 순차적 병합으로 상대 각도 결정
  - 구현: 각 클러스터를 독립적으로 배치

#### 올바른 이해
Text.docx에 따르면:
- ACC는 클러스터들을 **순차적으로 병합**
- Mid-point line 정렬로 상대적 각도 결정
- 최종 결과는 **하나의 큰 원**에 모든 area 배치
- 원래 `build_acc()` 로직이 맞았음!

### 3. GUI 레이아웃 개선

#### 불필요한 레이블 제거
- **제거된 레이블들**:
  - 각 패널의 메인 제목 (H3 스타일)
  - 덴드로그램 그래프 제목
  - "ACC Concentric Circles" 제목
  - "Local Clustering", "Global Clustering" 제목

#### 덴드로그램 헤더 레이아웃 정리
**Before:**
```
Local Clustering
                         [Show similarity values]
```

**After:**
```
Local                [Show similarity values]
```
- 한 줄로 통합: 제목(왼쪽) + 체크박스(오른쪽)
- 공간 절약 및 깔끔한 외관

#### 50:50 레이아웃 분할
- **왼쪽 패널**: Local와 Global 매트릭스가 1:1 비율
- **가운데 패널**: Local와 Global 덴드로그램이 1:1 비율
- `stretch=1` 파라미터 사용
- 구분선 추가:
  ```python
  separator = QLabel()
  separator.setFrameStyle(QLabel.Shape.HLine | QLabel.Shadow.Sunken)
  separator.setStyleSheet("background-color: #cccccc;")
  separator.setMaximumHeight(2)
  ```

#### 패널 폭 조절 기능
- **QSplitter 사용**: 드래그로 패널 폭 조절 가능
  ```python
  splitter = QSplitter(Qt.Orientation.Horizontal)
  splitter.addWidget(left_scroll)
  splitter.addWidget(center_scroll)
  splitter.addWidget(right_scroll)
  splitter.setSizes([600, 600, 600])  # 초기 크기
  self.setCentralWidget(splitter)
  ```
- 사용자가 필요에 따라 각 패널 크기 조절 가능

## 파일 변경 사항

### acc_gui.py
1. **Import 추가**: `QSplitter`
2. **StepDendrogramWidget**:
   - 헤더 레이아웃 변경 (제목 + 체크박스 한 줄)
3. **LeftPanel.setup_content()**:
   - "Local", "Global" 레이블만 유지
   - separator 추가
   - `stretch=1` 파라미터 추가
4. **CenterPanel.setup_content()**:
   - 불필요한 레이블 제거
   - separator 추가
   - `stretch=1` 파라미터 추가
5. **MainWindow.init_ui()**:
   - QSplitter로 3개 패널 구성
   - 드래그 가능한 구분선

### acc_core.py
1. **build_acc_merged()**: 원본 병합 로직 보존
2. **build_acc()**: 다중 클러스터 반환 (잘못된 접근)
   - 각 클러스터를 독립적으로 배치
   - 리스트로 반환

### acc_utils.py
- `build_acc_from_matrices()`: 새로운 구조에 맞게 간소화

### test_*.py
- 새로운 결과 구조에 맞게 출력 코드 수정

## 현재 상태

### 완료된 기능
- ✅ 덴드로그램 노드 값 표시 (체크박스)
- ✅ 소수점 자리수 통일 (.3f)
- ✅ 하이라이트 색상/타이밍 개선
- ✅ 올바른 위치 하이라이트
- ✅ GUI 레이아웃 정리
- ✅ 50:50 분할 및 구분선
- ✅ 패널 폭 조절 (QSplitter)

### 알려진 문제
- ⚠️ ACC 시각화: 모든 area가 x축 근처에 몰림
  - 원인: 알고리즘 잘못 이해
  - 각 클러스터를 독립적으로 배치하면 안 됨
  - 순차적 병합으로 상대 각도 결정해야 함
  - 원래 `build_acc_merged()` 로직으로 돌아가야 함

## 다음 작업

1. **ACC 알고리즘 수정**:
   - `build_acc_merged()`를 기본 `build_acc()`로 복원
   - Text.docx의 순차적 병합 로직 구현
   - Mid-point line 정렬 개선

2. **시각화 개선**:
   - 중간 병합 단계 표시 옵션
   - 최종 결과와 중간 단계 토글

3. **테스트**:
   - 실제 데이터로 각도 분산 확인
   - Text.docx 예시와 비교

## 사용자 피드백

> "모든 area/cluster 들이 다 x 축 가까이에 몰려있네. 서로의 관계에 따라 각도가 적절히 벌어져 있어야 되는 건데. 예를 들면 현재 샘플 데이터의 경우 N+(O+Q) 와 Y+(J+T) 두 개의 큰 클러스터가 있는데 이 두 클러스터가 합쳐지는 노드는 similarity 0.37 정도 되니까 120도 정도 벌어져 있어야 하거든."

→ Text.docx를 다시 읽고 ACC 알고리즘의 본질을 이해:
- 순차적 병합 과정에서 각도가 결정됨
- Mid-point line과 base line 정렬
- 최종적으로 하나의 큰 원에 모든 area 배치

## 결론

GUI 레이아웃은 크게 개선되었으나, ACC 시각화는 알고리즘을 잘못 이해하여 수정이 필요함. Text.docx의 순차적 병합 로직을 제대로 구현해야 각 area가 적절한 각도로 분산됨.
